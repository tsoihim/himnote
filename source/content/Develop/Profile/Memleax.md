<aside> Memleax : 메모리 누수 탐지를 위한 간단한 프로파일링 툴.

</aside>

레거시 코드 기반의 서비스 프로세스가 죽는 일이 발생
서버에 접속하여 syslog부터 확인해보니 OOM이 발생하여 서비스 프로세스가 시그널을 맞은 기록을 확인
코드를 보니 링크드 리스트를 이용하여 지속적으로 push/pop 하는 로직이 있었음. 그 과정에서 메모리 누수가 발생한 것으로 추정

우선 서비스 프로세스를 재기동하고나서, 터미널에서 watch를 걸어놓고 프로세스의 RSS와 VSZ 값을 확인
시간이 지남에 따라 메모리 할당량이 등차수열의 형태로 커지는 것을 확인
답은 확실하므로 이제 메모리 누수 지점을 찾기 시작
Valgrind를 사용할 수도 있지만 보다 간편하게 사용할 수 있는 memleax를 설치하여 사용

Memleax는 Ubuntu 환경에서 apt를 이용하여 쉽게 내려받을 수 있으며 사용법도 아래와 같이 매우 간단
메모리가 특정 시간 내에 반환되지 않는 경우 로그를 찍어주며, 해당 로그에는 call stack이 포함되므로 코드 내 어떤 부분에서 문제가 발생했는지 빠르게 파악하기 용이
```bash
# Usage
memleax [PID] -e [THRESHOLD]
	- e 옵션을 사용하여 PID가 할당받은 메모리 중 THRESHOLD 내에 반환되지 않는 경우 로그를 표출

# 실제 출력화면
nara@ubuntu:~ memleax 31524 -e 2
== Begin monitoring process 31524...
CallStack[1]: memory expires with 161 bytes, backtrace:
    0x00007f17f7846180  libc-2.23.so  __libc_malloc()+0
		...
    ...
```

위와 같이 memleax가 서비스 프로세스를 후킹하도록 하여, 제공되는 정보를 바탕으로 레거시 코드에서 총 두 곳의 메모리 누수지점을 빠르게 파악할 수 있었음
골치아픈 설정 대신 프로세스를 후킹하여 반환되지 않는 메모리만 빠르게 파악하고 싶은 경우 매우 유용

단, 특정한 경우 memleax가 메모리 누수를 잡기에 완벽하지 않을 수도 있음
어떤 프로세스들은 종료되기 전까지 특정 메모리를 할당받고 자주 반환하지 않도록 짜여있을 수도 있기 때문
이런 경우 THRESHOLD 값으로 메모리 누수를 파악하는 것이 큰 의미가 없음


**References**
- https://wubingzheng.github.io/memleax/